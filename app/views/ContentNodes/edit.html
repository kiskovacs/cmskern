#{extends 'main.html' /}
#{set title: 'Edit Content Node' /}

#{set 'moreScripts'}
<!--suppress XmlUnboundNsPrefix -->
<script type="text/javascript" src="@{'/public/javascripts/angular-0.9.19.min.js'}" ng:autobind></script>
#{/set}

<script type="text/javascript">

    DynFormCtrl.$inject = ['$resource'];

    function DynFormCtrl($resource) {
        this.ContentNode = $resource('/${contentType.slug}');

        // define data we are working with
        this.addresses = ${contentNode.pureJson.raw()};

        // define schema for the data (each attribute except for 'children' translates to
        // DOM element attribute of the same name).
        // if 'type' is undefined, it is considered to be 'text'
        this.addressSchema = ${contentType.jsonForm.raw()};

        this.validatorRegExps = {
            state: /[A-Z]{2}/
        }

        this.cancel();
    }

    DynFormCtrl.prototype = {
        cancel: function() {
            this.form = angular.copy(this.addresses);
        },

        save: function(addresses) {

            this.ContentNode.save({data: addresses});

            this.addresses = this.form;
            this.cancel();
        }
    };

    angular.widget('my:form', function(element) {
        this.directives(true);
        return function(element) {

            var scope = this,
                schema = scope.$eval(element.attr('schema')),
                model = element.attr('data'),
                fieldset = angular.element('<fieldset></fieldset>');

            angular.forEach(schema, function processField(field) {
                var name = this.model + '.' + field.name,
                    fieldElStr;

                if (field.children) {
                    angular.forEach(field.children, processField, {model: name});
                    return;
                }

                switch (field.type || 'text') {
                    case 'checkbox':; //fallthrough
                    case 'password':; //fallthrough
                    case 'text': {
                        fieldElStr = '<input name="' + name + '" ';

                        angular.forEach(field, function(value, attribute) {
                            if (attribute != 'tag') fieldElStr += attribute + '="' + value + '" ';
                        });

                        fieldElStr += '>';
                        break;
                    }
                    case 'textarea': {
                        fieldElStr = '<textarea name="' + name + '" ';

                        angular.forEach(field, function(attribute) {
                            fieldElStr += attribute + '="' + field[attribute] + '" ';
                        });

                        fieldElStr += '></textarea>';
                        break;
                    }
                }

                fieldset.append(angular.element('<label for="' + name + '">' + field.name + ':</label>'));
                fieldset.append(fieldElStr);
                fieldset.append('<br>');
            }, {model: model});
            angular.compile(fieldset)(scope);
            element.append(fieldset);
        };
    });


</script>


<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<h2>Edit content</h2>

<div ng:controller="DynFormCtrl">

    <!-- class="form-horizontal" -->
    <my:form ng:repeat="address in addresses" schema="addressSchema" data="address"></my:form>

    <button ng:click="save(addresses)">Save</button>

    <hr>

    <div id="model">
        addresses = <pre>{{addresses}}</pre>
    </div>

</div>