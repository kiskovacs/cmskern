#{extends 'main.html' /}
#{set title: 'Create New Content Node' /}

#{set 'moreScripts'}
    <!--suppress XmlUnboundNsPrefix -->
    <script type="text/javascript" src="@{'/public/javascripts/angular/angular.js'}" ng:autobind></script>
    <!-- script type="text/javascript" src="@{'/public/javascripts/services.js'}"></script -->
    <script type="text/javascript" src="@{'/public/javascripts/controllers.js'}"></script>
    <script type="text/javascript" src="@{'/public/javascripts/filters.js'}"></script>
    <script type="text/javascript" src="@{'/public/javascripts/widgets.js'}"></script>
#{/set}

<script type="text/javascript">

    function DynFormCtrl($resource, $location) {
        this.ContentNode = $resource('/${contentType.slug}');

        // define data we are working with
        this.contentNode = {
            titel: 'Start'
        };

        // define schema for the data (each attribute except for 'children' translates to
        // DOM element attribute of the same name).
        // if 'type' is undefined, it is considered to be 'text'
        this.contentSchema = ${contentType.jsonForm.raw()};

        this.validatorRegExps = {
            state: /[A-Z]{2}/
        };

        this.cancel();
    }

    DynFormCtrl.prototype = {
        cancel: function() {
            this.form = angular.copy(this.contentNode);
        },

        save: function(contentNode) {
            console.log("Start saving ...");
            this.ContentNode.save({data: contentNode});
            console.log("Finished save ..." +  contentNode);
            // var createdId = data.id;
            //window.location.href= "http://localhost:9000/"; // "/?highlightId=" + createdId;
            $location.update('http://localhost:9000/#NEW');
            self.$eval();
        }
    };

    DynFormCtrl.$inject = ['$resource', '$location'];


</script>


<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<h2>Create ${contentType.displayName}</h2>

<div ng:controller="DynFormCtrl">

    <form class="form-horizontal">
        <my:form schema="contentSchema" data="contentNode"></my:form>

        <div class="form-actions">
            <button ng:click="save(contentNode)" class="btn btn-primary">Save</button>
            <button ng:click="reset()" class="btn">Cancel</button>
        </div>
    </form>


    <hr>

    <div id="model">
        contentNode = <pre>{{contentNode}}</pre>
    </div>

</div>