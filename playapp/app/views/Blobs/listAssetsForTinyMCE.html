#{extends 'mini.html' /}
#{set title: 'Asset list' /}

#{set 'moreScripts'}
    #{script 'jquery/jquery-ui-1.8.23.custom.min.js' /}
    #{script 'tinymce/tiny_mce.js' /}
    #{script 'tinymce/jquery.tinymce.js' /}
    #{script 'tinymce/plugins/ajaxfilemanager/jscripts/for_tinymce.js' /}
#{/set}


<!-- Select one of the existing assets or upload a new one -->

<div id="file-uploader">
</div>

<!-- Search mask -->
<fieldset class="search_box">
    <!-- label for="search_term"></label -->
    <input type="text" id="search_term" name="search_term" value="" class="input-medium search-query" />
    <button id="search_assets" class="btn">Search by Title</button>
</fieldset>

<!-- Filled by AJAX search response-->
<div id="search_results"></div>


<script type="text/javascript">

    var THUMB_URL  = "/blobs/o/ID";

    $(function() {
        displaySelectionPage(1);
        createUploader();
    });

    function createUploader() {
        // initialize upload element
        var uploader = new qq.FileUploader({
            // pass the DOM node (ex. $(selector)[0] for jQuery users)
            element: document.getElementById('file-uploader'),
            // path to server-side upload
            action: '/blobs',
            inputName: 'filename',
            onComplete: function(id, fileName, responseJSON) {
                setTimeout(function(){
                    displaySelectionPage(1);   // refresh list
                }, 300);
            }
        });
    }

    // ~~

    function updateRef(val) {
        // selectFile('asset.url')"
        // var url = $(this).closest("tr").data("url");
        var url = THUMB_URL.replace(/ID/, val);
        console.log("---> " + val);
        selectFile(url);
    }

    // Trigger search and display HTML result
    $("#search_assets").click(function(event) {
        event.preventDefault();
        displaySelectionPage(1);
    });

    function displaySelectionPage(pageNr) {
        var search_term = $("#search_term").val();
        console.log("Search for assets: " + search_term + " (p. " + pageNr + ")");
        $.get('/helper/BlobSelection/searchByFilename', {query: search_term, page: pageNr}, function(data) {
            $('#search_results').html(data);
        });
    }

</script>
